#!/bin/bash

# definitions for the m-aur repo

# note: all variables are made 'local'

local REPONAME="m-aur"
local RELEASE_TAGS=(x86_64)
local SIGNER="manuel-192"

local ASSETSDIR="$PWD"
local PKGBUILD_ROOTDIR="$ASSETSDIR/PKGBUILDs"        # temporary copy, will be overwritten
local GITDIR="$ASSETSDIR/../../$REPONAME"            # may not be $REPONAME ...
local _PACKAGER="manuel <manuel@endeavouros.com>"

local PKGNAMES=(
    # Supported markings:
    #    pkgname          local package
    #    ./pkgname        (same as above)
    #    aur/pkgname      AUR package

    aur/archlinux-appstream-data-pamac

    aur/bauh

    # Brother multifunction printer drivers (scanner, printer):
    brother-dcp-l2537dw-printer
    brscan4

    aur/ccrypt
    aur/libpamac-git
    aur/notify-send.sh

    # aur/nvidia-470xx-settings
    # aur/nvidia-470xx-utils
    # aur/nvidia-390xx-utils

    #aur/nvidia-beta-dkms
    #aur/nvidia-utils-beta

    aur/pamac-aur-git
    aur/pandoc-bin
    #aur/paru
    aur/pikaur
    aur/qogir-icon-theme-git
    aur/qogir-gtk-theme-git
    # aur/qoi-git
    # aur/samsung-unified-driver
    #aur/rate-mirrors
    aur/shellcheck-bin
    shellcheck-min
    aur/vscodium-bin
    # aur/worm-git
    aur/xfe
    aur/yad-git
)
# PKGNAMES=( aur/pandoc-bin aur/shellcheck-bin )   # TESTING code!

_pkgver_to_github_latest_tag_release() {
    # Change pkgver in PKGBUILD to the latest available.
    # A changed pkgver *should* fail the build.

    local page="$1"
    local PKGBUILD="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname ${FUNCNAME[1]})"/PKGBUILD
    local old_pkgver=$(_Get_pkgver "$PKGBUILD")
    local new_pkgver=$(curl -Lsm 20 -o- "$page" | grep /releases/tag/ | head -n1 | sed -e 's|.*/releases/tag/\([^\"]*\).*|\1|' -e 's|^[^0-9]*||')

    if [ $(vercmp "$new_pkgver" "$old_pkgver") -gt 0 ] ; then
        # printf "==> auto-updating PKGBUILD, " >&2
        # printf "# " >&2
        sed -i "$PKGBUILD" \
            -e "/^pkgver=/a \pkgver=$new_pkgver   # latest available"
        updpkgsums "$PKGBUILD" 2>/dev/null
        return 11        # return value 1 indicates: pkgver was changed
    fi
}

_pandoc-bin_hook() {
    _pkgver_to_github_latest_tag_release https://github.com/jgm/pandoc/releases/latest
}

_shellcheck-bin_hook() {
    _pkgver_to_github_latest_tag_release https://github.com/koalaman/shellcheck/releases/latest
}

_rate-mirrors_hook() {
    local PKGBUILD="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    sed -i $PKGBUILD \
        -e "s|^\(pkgrel=.*\)|\1.4|" \
        -e "/^depends=/a \ \nreplaces=(rate-mirrors-bin)"
}

_yad-git_hook() {
    local PKGBUILD="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    sed -i $PKGBUILD \
        -e "s| 'i686'||" \
        -e 's|--with-gtk=gtk3|--enable-gio --enable-gspell --enable-sourceview|' \
        -e 's|http://|https://|'
}

_nvidia-470xx-utils_hook() {
    local PKGBUILD="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    sed -i $PKGBUILD \
        -e "/^package_opencl-nvidia-470xx/,/^}$/d" \
        -e "s|'opencl-nvidia-470xx'||" \
        -e 's|http://|https://|'

    return

    ##### TESTING !!!

    sed -i $PKGBUILD \
        -e "s|^pkgrel=2|pkgrel=1.1|"
}

_nvidia-390xx-utils_hook() {
    local PKGBUILD="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    sed -i $PKGBUILD \
        -e "/^package_opencl-nvidia-390xx/,/^}$/d" \
        -e "s|'opencl-nvidia-390xx'||" \
        -e 's|http://|https://|'
}

_nvidia-390xx-dkms_hook() {
    # remove dependency nvidia-390xx-utils
    local basedir="$PKGBUILD_ROOTDIR"/nvidia-390xx
    mv "$basedir" "$basedir"-dkms
    local pkgbuild="$basedir"-dkms/PKGBUILD
    _is_this_pkgname_included || {
        echo "Error: $FUNCNAME: cannot read file '$pkgbuild'." >&2
        exit 1
    }
    if [ -r "$pkgbuild" ] ; then
        sed -i "$pkgbuild" \
            -e 's|"nvidia-390xx-utils=.*"||' \
            -e 's|^pkgname=(nvidia-390xx |pkgname=(|'
    fi
}

if [ 0 -eq 1 ] && [ "$(lspci -vnn | grep -Po ' Display .*\[[0-9a-f]*:\K[0-9a-f]*')" = "6660" ] ; then
    PKGNAMES+=(
        aur/nvidia-390xx-utils     # nvidia stuff only on the laptop!
        aur/nvidia-390xx-dkms
    )
fi

_is_this_pkgname_included() {
    local Pkgname="$1"
    test -z "$Pkgname" && Pkgname="$(__generic_get_pkgname "${FUNCNAME[1]}")"
    if [ -z "$Pkgname" ] ; then
        echo "${FUNCNAME[0]}: no pkgname!" >&2
        return 1
    fi
    local xx
    for xx in "${PKGNAMES[@]}" ; do
        case "$xx" in
            "$Pkgname" | "aur/$Pkgname" | "./$Pkgname") return 0 ;;  # accepted formats
        esac
    done
    return 1     # not in $PKGNAMES
}
__generic_get_pkgname() { local funcname="$1" ; echo "$funcname" | cut -d '_' -f 2 ; }
__generic_fix_https() {
    local Pkgname="$1"
    if [ -z "$Pkgname" ] ; then
        echo "${FUNCNAME[0]}: no pkgname!" >&2
        return 1
    fi
    _is_this_pkgname_included $Pkgname && {
        sed -i "$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD \
            -e 's|http://|https://|'
    }
}

__generic_version_check() {
    # Check for a version change.
    # If version has changed, inform user and stop building.

    local Pkgname="$(__generic_get_pkgname ${FUNCNAME[1]})"
    local Pkgbuild="$PKGBUILD_ROOTDIR/$Pkgname/PKGBUILD"

    _is_this_pkgname_included "$Pkgname" || {
        echo "Error: $FUNCNAME: cannot read file '$Pkgbuild'." >&2
        exit 1
    }
    if [ -r "$Pkgbuild" ] ; then
        local version_check="$PKGBUILD_ROOTDIR/$Pkgname/version-check"
        if [ -r "$version_check" ] ; then
            local Pkgver=$(grep ^pkgver= "$Pkgbuild" | cut -d'=' -f2)
            "$version_check" $Pkgname $Pkgver || exit 1
        else
            if [ -n "$(grep -w "^_version_check" "$Pkgbuild")" ] ; then
                source "$Pkgbuild"
                _version_check || exit 1
            fi
        fi
    fi
}

_Get_pkgver() {
    local Pkgbuild="$1"
    grep "^pkgver=" "$Pkgbuild" | cut -d '=' -f 2 | sed "s|^[\"']\(.*\)[\"']$|\1|"
}


_archlinux-appstream-data-pamac_hook() {
    # Get rid of epoch!
    # Change epoch and pkgver to one pkgver: $epoch$pkgver

    local Pkgbuild="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    local line_epoch="$(grep "^epoch=" "$Pkgbuild")"
    if [ -n "$line_epoch" ] ; then
        local Epoch=$(echo "$line_epoch" | cut -d '=' -f2)
        local Pkgver=$(grep "^pkgver=" "$Pkgbuild" | cut -d '=' -f2)
        if [ 1 -eq 1 ] ; then
            sed -i "$Pkgbuild" \
                -e "/^pkgver=/a \ _pkgver_orig=$Pkgver" \
                -e 's|^epoch=|# epoch=|' \
                -e 's|$pkgver|$_pkgver_orig|g' \
                -e 's|${pkgver}|$_pkgver_orig|g' \
                -e "s|^pkgver=|pkgver=${Epoch}|"
            if [ 1 -eq 1 ] ; then
                sed -i "$Pkgbuild" \
                    -e 's|^\(pkgrel=[0-9]*\)$|\1.1|'
            fi
        fi
    fi
}

_yay-bin_hook_test() {
    # change pkgname from yay-bin to yay
    local pkgbuild="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    _is_this_pkgname_included || {
        echo "Error: $FUNCNAME: cannot read file '$pkgbuild'." >&2
        exit 1
    }
    if [ -r "$pkgbuild" ] ; then
        sed -i "$pkgbuild" \
            -e 's|^pkgname=yay-bin|pkgname=yay|'
    fi
}

_brscan4_hook() {
    __generic_version_check
}

_brother-dcp-l2537dw-printer_hook() {
    __generic_version_check
}

_pamac-aur_hook() {
    :  # nothing to do?
}

_pamac-aur_hook_for_8.0.4() {
    return
    
    local pkgbuild="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"/PKGBUILD
    _is_this_pkgname_included || {
        echo "Error: $FUNCNAME: cannot read file '$pkgbuild'." >&2
        exit 1
    }

    if [ -r "$pkgbuild" ] ; then
        if [ "$(grep MaxParallelDownloads "$pkgbuild")" = "" ] ; then
            local linetoadd="sed -i data/config/pamac.conf -e 's|^MaxParallelDownloads = .*\$|MaxParallelDownloads = 0|'"
            local ver="$(_Get_pkgver "$pkgbuild")"
            ver+="_m"
            sed -i "$pkgbuild" \
                -e '/  \# adjust version string/i \  '"$linetoadd"''
            #   -e 's|^pkgver=.*$|pkgver='"$ver"'         # suffix "_m" because config changed in prepare()|'  # NOT WORKING!
        fi
    fi
}

_pamac-gtk_hook() {
    # This package extracts to folder 'pamac' instead of 'pamac-gtk'!
    # Let's change it back.

    local folder_expected="$PKGBUILD_ROOTDIR"/"$(__generic_get_pkgname $FUNCNAME)"
    local folder_extracted="$PKGBUILD_ROOTDIR"/pamac

    if [ -d "$folder_extracted" ] && [ ! -d "$folder_expected" ] ; then
        mv "$folder_extracted" "$folder_expected"
    fi
}

_bashdb_hook() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD

    if [ "$(grep "^_ver=" "$Pkgbuild" | cut -d'=' -f2)" = "'5.0-1.1.2'" ] ; then
        # support also bash version 5.1

        local line="s/'5.0')/'5.0' | '5.1')/"

        sed -i "$Pkgbuild" \
            -e "/^[ ]*#sed /a \  sed -i configure -e \"$line\""

        # show in pkgrel we changed this package
        if [ "$(grep ^pkgrel= "$Pkgbuild" | cut -d'=' -f2)" = "'1'" ] ; then
            sed -i "$Pkgbuild" \
                -e 's|^pkgrel=.*|pkgrel=1.1|'
        fi
    fi
}

_bashdb_hook_temp() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD

    source "$Pkgbuild"

    if [ "$pkgver" = "5.0_1.1.0" ] ; then
        if [ "$pkgrel" = "1" ] ; then
            sed -i "$Pkgbuild" \
                -e 's|^pkgrel=.*$|pkgrel=1.1|'
        fi
    fi
}

_ccrypt_hook() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD

    __generic_fix_https $Pkgname
    pushd "$PKGBUILD_ROOTDIR"/$Pkgname >/dev/null || return 1
    source PKGBUILD || return 1
    #wget -q "${source}" || return 1
    curl -Lfsm 10 -o $(basename $source) "${source}" || return 1
    local sum=$(sha512sum $(basename "$source") | awk '{print $1}')
    echo "sha512sums=($sum)" >> PKGBUILD
    popd >/dev/null

    return

    #source "$Pkgbuild"
    if [ "$pkgver" = "1.11" ] ; then
        if [ "$pkgrel" = "1" ] ; then
            sed -i "$Pkgbuild" \
                -e 's|^pkgrel=.*$|pkgrel=1.1|'
        fi
    fi
}

_paper-icon-theme-git_hook() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD
    local cleanup=""
    local commits commit
    local data=$(curl -s https://github.com/snwh/paper-icon-theme)

    commits=$(echo "$data" | grep -B2 " commits$"   | head -n1 | sed 's|[ ]*<strong>\([0-9]*\)</strong>$|\1|')  # 832
    commit=$( echo "$data" | grep ">Permalink<" | sed 's|.*/tree/\([0-9a-f]*\)".*|\1|')                         # aa3e8af7a1f0831a51fd7e638a4acb077a1e5188
    commit=${commit::7}                                                                                         # aa3e8af

    cleanup+='    local dir="$srcdir/../$pkgname"\n'
    cleanup+='    [ -d "$dir" ] && rm -rf "$dir"'

    # Changes:
    # - remove reference to $srcdir
    # - get pkgver from github info
    # - remove pkgver()
    # - conflicts with paper-icon-theme
    # - add some cleanup

    sed -i "$Pkgbuild" \
        -e 's|cd "$srcdir/$pkgname"$|cd "$pkgname"|' \
        -e "s|^pkgver=.*|pkgver=$commits.$commit|" \
        -e 's|^pkgver()|_pkgver_not_used()|' \
        -e "/^provides=(/a \conflicts=(paper-icon-theme)" \
        -e "/ ninja -C /a \    # cleanup\n$cleanup"
    return 11 # pkgver was changed
}

_xfe_hook_temp() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD

    source "$Pkgbuild"

    if [ "$pkgver" = "1.43.2" ] ; then
        if [ "$pkgrel" = "2" ] ; then
            sed -i "$Pkgbuild" \
                -e 's|^pkgrel=.*$|pkgrel=2.1|'
        fi
    fi
}
_virtualbox-ext-oracle_hook() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD
    local Pkgver=$(_Get_pkgver "$Pkgbuild")

    # add a version check, virtualbox must be at least the same version
    #sed -i "$Pkgbuild" -e '/^noextract=/'a'depends=("virtualbox>=$pkgver")'
    sed -i "$Pkgbuild" \
        -e "s|^depends=('virtualbox'|depends=('virtualbox>=$Pkgver'|"
}

_pamac-aur-git_hook() {
    # Find the (bleeding edge) real pkgver from gitlab source code.

    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    local Pkgdir="$PKGBUILD_ROOTDIR"/$Pkgname
    local Pkgbuild="$Pkgdir"/PKGBUILD
    local Pkgver
    local pamacdir=pamac
    local url=https://gitlab.manjaro.org/applications/$pamacdir

    pushd "$Pkgdir" >/dev/null

    git clone $url 2>/dev/null || {
        popd >/dev/null
        echo "Sorry, '$url' is not responding." >&2
        return 1
    }

    pushd $pamacdir >/dev/null

    Pkgver="$(git describe --long --tags | sed 's/\([^-]*-g\)/r\1/;s/-/./g' | cut -c2-48)"

    popd >/dev/null

    rm -rf $pamacdir
    local currpkgver="$(_Get_pkgver "$Pkgbuild")"
    if [ "$Pkgver" != "$currpkgver" ] ; then
        sed -i "$Pkgbuild" \
            -e 's|^pkgver=.*$|pkgver='"$Pkgver"'|'
        return 11  # pkgver was changed
        # echo -n "# " >&2                               # show user we have changed pkgver!
    fi

    popd >/dev/null
}

_vivaldi_hook_have_latest() {
    local Pkgname="$(__generic_get_pkgname $FUNCNAME)"
    _is_this_pkgname_included $Pkgname || {
        echo "Error: $Pkgname: $FUNCNAME: not included in the list!" >&2
        return 1
    }

    local Pkgbuild="$PKGBUILD_ROOTDIR"/$Pkgname/PKGBUILD
    local Url="$(grep "^url=" "$Pkgbuild" | cut -d '=' -f 2 | tr -d '"')"     # here is the official code
    local Pkgver="$(_Get_pkgver "$Pkgbuild")"                                 # package version info from AUR PKGBUILD
    local Pkgrel="$(grep "^pkgrel=" "$Pkgbuild" | cut -d '=' -f 2)"           # package release info from AUR PKGBUILD
    local tmpfile=$(mktemp)
    local latest built File sum

    wget -q --timeout=10 -O $tmpfile $Url/download || {
        echo "Error: $Pkgname: $FUNCNAME: info download failed." >&2
        rm -f $tmpfile
        return 1
    }

    latest="$(grep '\.x86_64\.rpm' $tmpfile | sed -e 's|^.*/stable/vivaldi-stable-||' -e 's|\.x86_64.*$||')"
    rm -f $tmpfile
    built="$(pkghlp --pkgver $Pkgname)"

    sed -i "$Pkgbuild" \
        -e 's|^pkgver=.*$|pkgver='"${latest:: -2}"'|' \
        -e 's|^_rpmversion=.*$|_rpmversion='"${latest}"'|'

    if [ $(vercmp "$latest" "$built") -gt 0 ] ; then
        test $(vercmp "$latest" "${Pkgver}-$Pkgrel") -gt 0 && \
            echo "Warning: $Pkgname: AUR PKGBUILD is outdated ($Pkgver-${Pkgrel} < $latest), check '$Url'." >&2
        echo "Info: $Pkgname: adjusting version to $latest." >&2

        File=vivaldi-stable-${latest}.x86_64.rpm
        pkghlp --cacheget $File
        test -r $File || wget -q --timeout=20 -O $File https://downloads.vivaldi.com/stable/$File || \
            { echo "ERROR: wget $File failed." >&2 ; return 1 ; }
        pkghlp --cacheput $File
        sum="$(sha512sum $File | awk '{print $1}')"
        sed -i "$Pkgbuild" \
            -e 's|^sha512sums=.*$|sha512sums=('$sum')|'
        return 11 # pkgver was changed
    fi
}

# These hooks provide the opportunity to change AUR package files if needed.
declare -A ASSET_PACKAGE_HOOKS                                  # functions: use package name like _"pkgname"_hook_do_something

#ASSET_PACKAGE_HOOKS["tkpacman"]="__generic_fix_https tkpacman"
#ASSET_PACKAGE_HOOKS["firefox-beta"]="__generic_fix_https firefox-beta"
#ASSET_PACKAGE_HOOKS["pamac-gtk"]="_pamac-gtk_hook"
#ASSET_PACKAGE_HOOKS["vivaldi"]="_vivaldi_hook_have_latest"
#ASSET_PACKAGE_HOOKS["voikko-libreoffice"]="__generic_fix_https voikko-libreoffice"
#ASSET_PACKAGE_HOOKS["voikko-fi"]="__generic_fix_https voikko-fi"
#ASSET_PACKAGE_HOOKS["termcap"]="__generic_fix_https termcap"

#ASSET_PACKAGE_HOOKS["opera-beta"]="__generic_fix_https opera-beta"
#ASSET_PACKAGE_HOOKS["opera-developer"]="__generic_fix_https opera-developer"

#ASSET_PACKAGE_HOOKS["pamac-aur"]=_pamac-aur_hook
#ASSET_PACKAGE_HOOKS["pamac-aur-git"]=_pamac-aur-git_hook
ASSET_PACKAGE_HOOKS["virtualbox-ext-oracle"]=_virtualbox-ext-oracle_hook
#ASSET_PACKAGE_HOOKS["xfe"]=_xfe_hook_temp
ASSET_PACKAGE_HOOKS["bashdb"]=_bashdb_hook
ASSET_PACKAGE_HOOKS["ccrypt"]="_ccrypt_hook"
ASSET_PACKAGE_HOOKS["nvidia-470xx-utils"]=_nvidia-470xx-utils_hook
ASSET_PACKAGE_HOOKS["nvidia-390xx-utils"]=_nvidia-390xx-utils_hook
ASSET_PACKAGE_HOOKS["nvidia-390xx-dkms"]=_nvidia-390xx-dkms_hook
ASSET_PACKAGE_HOOKS["yad-git"]=_yad-git_hook
ASSET_PACKAGE_HOOKS["shellcheck-bin"]=_shellcheck-bin_hook

ASSET_PACKAGE_HOOKS["yay-bin"]=_yay-bin_hook_test
ASSET_PACKAGE_HOOKS["brscan4"]=_brscan4_hook
ASSET_PACKAGE_HOOKS["brother-dcp-l2537dw-printer"]=_brother-dcp-l2537dw-printer_hook
#ASSET_PACKAGE_HOOKS["paper-icon-theme-git"]=_paper-icon-theme-git_hook

ASSET_PACKAGE_HOOKS["archlinux-appstream-data-pamac"]=_archlinux-appstream-data-pamac_hook
ASSET_PACKAGE_HOOKS["pandoc-bin"]=_pandoc-bin_hook

ASSET_PACKAGE_HOOKS["rate-mirrors"]=_rate-mirrors_hook

# Additional options for makepkg usage.
declare -A PKG_MAKEPKG_OPTIONS
PKG_MAKEPKG_OPTIONS[nvidia-470xx-settings]="--nodeps"
PKG_MAKEPKG_OPTIONS[nvidia-390xx-settings]="--nodeps"

# Hook functions are run after RationalityTests and initial PKGBUILDs setup in assets.make.
# There may be several hook functions.

_pkgbuilds_m_hook()
{
    # A hook function to make sure local PKGBUILDS from AUR are up to date.

    local dir_above_pkgbuilds="$PKGBUILD_ROOTDIR"/..
    local conf=assets.conf
    local url=https://github.com/manuel-192/"$REPONAME".git

    pushd "$dir_above_pkgbuilds" >/dev/null || {
        echo "Error: $conf: cannot cd to '$dir_above_pkgbuilds'." >&2
        exit 1
    }
    rm -rf "$PKGBUILD_ROOTDIR"
    mkdir -p "$PKGBUILD_ROOTDIR"
    pushd "$PKGBUILD_ROOTDIR" >/dev/null
    git clone "$url" >& /dev/null || {
        echo "Error: $conf: git clone $url failed." >&2
        popd >/dev/null
        popd >/dev/null
        exit 1
    }
    if [ -d "$PKGBUILD_ROOTDIR"/$REPONAME/PKGBUILDs ] ; then
        mv "$PKGBUILD_ROOTDIR"/$REPONAME/PKGBUILDs/* "$PKGBUILD_ROOTDIR"/ || {
            echo "Error: $conf: $FUNCNAME: mv $PKGBUILD_ROOTDIR/PKGBUILDs subdirs failed." >&2
            popd >/dev/null
            popd >/dev/null
            exit 1
        }
    fi
    rm -rf "$PKGBUILD_ROOTDIR/$REPONAME"
    touch "$PKGBUILD_ROOTDIR"/NOTE-THIS-IS-A-TEMPORARY-FOLDER
    popd >/dev/null
    popd >/dev/null
}

local ASSET_HOOKS=(
    _pkgbuilds_m_hook     # currently no local PKGBUILDs exist !!
)


_update_m_more_repo() {
    cd "$GITDIR"
    ./GitUpdate
}

_remove_unneeded_build_deps() {
    local pkgs=(
        flatpak
    )
    local msgs=(
        "Removing flatpak (pamac-aur dependency)"
    )
    local ix

    for ((ix=0; ix < ${#pkgs[@]}; ix++)) ; do
        pacman -Q "${pkgs[$ix]}" >& /dev/null && {
            echo "${msgs[$ix]}: " >&2
            su-c_wrapper pacman -Rsn "${pkgs[$ix]}"
        }
    done
}

local ASSET_POST_HOOKS=(
    _remove_unneeded_build_deps
    # _update_m_more_repo
)
